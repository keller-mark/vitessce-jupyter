from pathlib import Path, PosixPath
from snakemake.remote.S3 import RemoteProvider as S3RemoteProvider

S3 = S3RemoteProvider()

#BUCKET_NAME = "vitessce-data"
BUCKET_NAME = "vitessce-data"
BUCKET = PosixPath(BUCKET_NAME) / "0.0.32" / "master_release"

DATA_DIR = Path("data")
PROCESSED_DIR = DATA_DIR / "processed"

subworkflow habib_2017:
    workdir:
        "habib_2017_nature_methods"
    snakefile:
        "habib_2017_nature_methods/Snakefile"

subworkflow mouse_brain_10x:
    workdir:
        "mouse_brain_10x_visium"
    snakefile:
        "mouse_brain_10x_visium/Snakefile"

rule all:
    input:
        habib_2017=habib_2017(str(PROCESSED_DIR / "habib_2017.h5ad.zarr")),
        mouse_brain_10x=mouse_brain_10x(str(PROCESSED_DIR / "mouse_brain_10x.h5ad.zarr")),
    params:
        # This should be in output: https://github.com/snakemake/snakemake/issues/870
        habib_2017=S3.remote(str(BUCKET / "habib_2017" / "habib_2017.h5ad.zarr")),
        mouse_brain_10x=S3.remote(str(BUCKET / "mouse_brain_10x" / "mouse_brain_10x.h5ad.zarr")),
    shell:
        """
        aws s3 cp --recursive {input.habib_2017} s3://{params.habib_2017} && \
        aws s3 cp --recursive {input.mouse_brain_10x} s3://{params.mouse_brain_10x}
        """
